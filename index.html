<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrator de Planilha de PDF com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        .animate-spin {
          animation: spin 1s linear infinite;
        }
    </style>
    <!-- Adicionando a biblioteca js-xlsx para salvar em .xlsx -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body class="min-h-screen bg-gray-100 p-8 flex flex-col items-center font-sans text-gray-800">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-4xl">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-900">
            Extrator de Planilha de PDF com IA
        </h1>
        <p class="text-center text-gray-600 mb-8">
            Anexe um PDF de fatura ou pedido de venda e a IA extrairá os dados em uma tabela.
        </p>

        <!-- Dropzone e botões de ação -->
        <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-8">
            <div id="dropzone" class="flex-1 border-2 border-dashed rounded-lg p-6 text-center transition-colors duration-200 cursor-pointer border-gray-300 bg-gray-50 hover:bg-gray-100">
                <input id="file-input" type="file" class="hidden" accept="application/pdf">
                <div id="dropzone-content">
                    <p class="text-gray-500">Arraste e solte o PDF aqui</p>
                </div>
            </div>
            <div class="flex flex-col md:flex-row gap-2">
                <button id="extract-button" disabled
                    class="flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200">
                    <svg id="extract-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2">
                        <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                    <span>Extrair Dados</span>
                </button>
                <button id="download-button" disabled
                    class="flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-indigo-700 bg-indigo-100 hover:bg-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>
                    </svg>
                    Salvar como XLSX
                </button>
            </div>
        </div>

        <!-- Campo de prompt adicional para a IA -->
        <div class="mb-8">
            <label for="additional-prompt" class="block text-sm font-medium text-gray-700 mb-2">
              Instruções Adicionais para a IA:
            </label>
            <textarea
              id="additional-prompt"
              rows="3"
              class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 mt-1 block w-full sm:text-sm border-gray-300 rounded-md p-2"
              placeholder="Ex: 'Não inclua a coluna de preço total' ou 'A coluna de descrição deve ser em maiúsculas'."
            ></textarea>
        </div>


        <!-- Indicador de erro -->
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4">
            <span id="error-text" class="block sm:inline"></span>
        </div>
        
        <!-- Indicador de carregamento com status e tempo -->
        <div id="loading-indicator" class="hidden items-center justify-center gap-4 mt-8 text-gray-600">
            <svg id="loading-spinner" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-indigo-600 animate-spin">
              <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
            </svg>
            <span id="status-message" class="font-medium"></span>
            <span id="elapsed-time" class="font-bold text-indigo-700"></span>
        </div>
        
        <!-- Exibição do tempo final -->
        <div id="final-time-display" class="hidden text-center mt-4 text-sm font-medium text-gray-600">
            Tempo de extração: <span id="final-time" class="font-bold text-indigo-700"></span>
        </div>
        
        <!-- Log de processamento -->
        <div id="processing-log" class="hidden mt-8">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Logs de Processamento</h3>
            <div id="log-content" class="bg-gray-100 text-gray-700 p-4 rounded-lg overflow-y-auto max-h-60" style="white-space: pre-wrap;">
                <p class="text-sm"></p>
            </div>
        </div>

        <!-- Tabela de resultados -->
        <div id="table-container" class="hidden overflow-x-auto rounded-lg shadow-md mt-8">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-indigo-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider">Item</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider">Produto</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider">Descrição</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider">UM</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider">Quantidade</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider">Preço Venda</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-indigo-700 uppercase tracking-wider">Total</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                </tbody>
            </table>
        </div>

        <!-- Mensagem de fallback para dados vazios -->
        <div id="no-data-message" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg mt-8">
            <p class="font-bold">Nenhum dado encontrado</p>
            <p>O PDF foi processado, mas não foi possível extrair informações de tabela com o padrão especificado.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('file-input');
            const dropzoneContent = document.getElementById('dropzone-content');
            const extractButton = document.getElementById('extract-button');
            const downloadButton = document.getElementById('download-button');
            const additionalPrompt = document.getElementById('additional-prompt');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const loadingIndicator = document.getElementById('loading-indicator');
            const statusMessageElem = document.getElementById('status-message');
            const elapsedTimeElem = document.getElementById('elapsed-time');
            const finalTimeDisplay = document.getElementById('final-time-display');
            const finalTimeElem = document.getElementById('final-time');
            const tableContainer = document.getElementById('table-container');
            const tableBody = document.getElementById('table-body');
            const noDataMessage = document.getElementById('no-data-message');
            const processingLog = document.getElementById('processing-log');
            const logContent = document.getElementById('log-content');

            let file = null;
            let data = null;
            let loading = false;
            let error = null;
            let finalTime = null;
            let timer = null;
            let currentElapsedTime = 0;

            const updateUI = () => {
                extractButton.disabled = loading || !file;
                downloadButton.disabled = !data || data.length === 0;
                additionalPrompt.disabled = loading;

                if (file) {
                    dropzoneContent.innerHTML = `
                        <div class="flex items-center justify-center gap-2 text-indigo-700 font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="8" x2="16" y1="13" y2="13"/><line x1="8" x2="16" y1="17" y2="17"/><line x1="10" x2="14" y1="9" y2="9"/>
                            </svg>
                            <span>${file.name}</span>
                            <button id="remove-file-btn" class="text-gray-500 hover:text-red-500 p-1 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4">
                                    <path d="M18 6L6 18"/><path d="M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    `;
                    document.getElementById('remove-file-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        file = null;
                        data = null;
                        updateUI();
                    });
                } else {
                    dropzoneContent.innerHTML = `<p class="text-gray-500">Arraste e solte o PDF aqui</p>`;
                }

                if (loading) {
                    loadingIndicator.classList.remove('hidden');
                    loadingIndicator.classList.add('flex');
                    processingLog.classList.remove('hidden');
                } else {
                    loadingIndicator.classList.add('hidden');
                    loadingIndicator.classList.remove('flex');
                    processingLog.classList.add('hidden');
                }

                if (error) {
                    errorMessage.classList.remove('hidden');
                    errorText.textContent = error;
                } else {
                    errorMessage.classList.add('hidden');
                }

                if (data && data.length > 0) {
                    tableContainer.classList.remove('hidden');
                    renderTable(data);
                } else {
                    tableContainer.classList.add('hidden');
                }

                if (data && data.length === 0 && !loading) {
                    noDataMessage.classList.remove('hidden');
                } else {
                    noDataMessage.classList.add('hidden');
                }

                if (finalTime !== null) {
                  finalTimeDisplay.classList.remove('hidden');
                  finalTimeElem.textContent = finalTime;
                } else {
                  finalTimeDisplay.classList.add('hidden');
                }
            };

            const startTimer = () => {
                currentElapsedTime = 0;
                elapsedTimeElem.textContent = `(${currentElapsedTime}s)`;
                timer = setInterval(() => {
                    currentElapsedTime++;
                    elapsedTimeElem.textContent = `(${currentElapsedTime}s)`;
                }, 1000);
            };

            const stopTimer = () => {
                if (timer) {
                    clearInterval(timer);
                    timer = null;
                }
            };

            const processFile = async () => {
                loading = true;
                error = null;
                data = null;
                finalTime = null;
                logContent.textContent = '';
                statusMessageElem.textContent = 'Iniciando o processo...';
                startTimer();
                updateUI();

                try {
                    const apiStartTime = Date.now();
                    const reader = new FileReader();
                    
                    reader.onload = async (e) => {
                        try {
                            const pdfData = btoa(String.fromCharCode(...new Uint8Array(e.target.result)));
                            logContent.textContent += `Lendo o arquivo PDF e enviando para o servidor...\n`;

                            // Chamada para a função Serverless do Vercel
                            const response = await fetch('/api/extract', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    pdfData: pdfData,
                                    additionalPrompt: additionalPrompt.value
                                })
                            });

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.error || `Erro na requisição: ${response.status}`);
                            }

                            const result = await response.json();

                            if (result && result.length > 0) {
                                data = result;
                                statusMessageElem.textContent = 'Dados extraídos com sucesso!';
                                logContent.textContent += `Resposta do servidor recebida. Tabela gerada.\n`;
                            } else {
                                error = 'Não foi possível extrair os dados. O formato do PDF pode não ser suportado.';
                                statusMessageElem.textContent = 'Erro na extração.';
                                logContent.textContent += `Erro: Resposta do servidor vazia ou inválida.\n`;
                            }
                        } catch (e) {
                            error = `Erro ao processar o arquivo: ${e.message}`;
                            statusMessageElem.textContent = 'Erro na extração.';
                            logContent.textContent += `Erro: ${e.message}\n`;
                        } finally {
                            loading = false;
                            stopTimer();
                            finalTime = ((Date.now() - apiStartTime) / 1000).toFixed(2);
                            additionalPrompt.value = '';
                            updateUI();
                        }
                    };
                    
                    reader.onerror = (e) => {
                        loading = false;
                        error = `Erro ao ler o arquivo: ${e.message}`;
                        statusMessageElem.textContent = 'Erro na leitura.';
                        stopTimer();
                        updateUI();
                    };

                    reader.readAsArrayBuffer(file);
                } catch (e) {
                    loading = false;
                    error = `Erro inesperado: ${e.message}`;
                    statusMessageElem.textContent = 'Erro inesperado.';
                    stopTimer();
                    updateUI();
                }
            };

            // Event listeners
            dropzone.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const selectedFile = e.target.files[0];
                    if (selectedFile.type === 'application/pdf') {
                        file = selectedFile;
                        error = null;
                        data = null;
                        updateUI();
                    } else {
                        error = 'Por favor, anexe um arquivo PDF válido.';
                        file = null;
                        updateUI();
                    }
                }
            });

            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('border-indigo-500', 'bg-indigo-50');
            });

            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('border-indigo-500', 'bg-indigo-50');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('border-indigo-500', 'bg-indigo-50');
                const droppedFiles = e.dataTransfer.files;
                if (droppedFiles.length > 0 && droppedFiles[0].type === 'application/pdf') {
                    file = droppedFiles[0];
                    error = null;
                    data = null;
                    updateUI();
                } else {
                    error = 'Por favor, anexe um arquivo PDF válido.';
                    file = null;
                    updateUI();
                }
            });

            extractButton.addEventListener('click', processFile);

            downloadButton.addEventListener('click', () => {
                if (!data || data.length === 0) return;
                
                const headers = ['Item', 'Produto', 'Descricao', 'UM', 'Quantidade', 'Preco Venda', 'Total'];
                const worksheetData = [
                    headers,
                    ...data.map(row => headers.map(header => row[header.toLowerCase().replace(/ /g, '')]))
                ];

                const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Dados");

                XLSX.writeFile(workbook, "dados_extraidos.xlsx");
            });

            updateUI();
        });
    </script>
</body>
</html>
